name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        uv sync
        uv pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        uv run pyinstaller docx_extractor_gui.spec

    - name: Create distribution archive
      shell: pwsh
      run: |
        cd dist
        Compress-Archive -Path DOCX_Extractor.exe -DestinationPath DOCX_Extractor_Windows_x64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/DOCX_Extractor_Windows_x64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        uv sync
        uv pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        uv run pyinstaller docx_extractor_gui.spec

    - name: Create distribution archive
      run: |
        cd dist
        tar -czf DOCX_Extractor_macOS_x64.tar.gz DOCX_Extractor.app

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: dist/DOCX_Extractor_macOS_x64.tar.gz

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: ./artifacts

    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: macos-build
        path: ./artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./artifacts/DOCX_Extractor_Windows_x64.zip
          ./artifacts/DOCX_Extractor_macOS_x64.tar.gz
        body: |
          ## DOCX Document Extractor - Release ${{ github.ref_name }}

          ### Features
          - Batch processing with async API calls
          - Dynamic token windowing to prevent output truncation
          - GUI application with Azure OpenAI configuration
          - Support for CSV and JSON output formats
          - Real-time progress tracking with progress bar

          ### Installation

          **Windows:**
          1. Download `DOCX_Extractor_Windows_x64.zip`
          2. Extract the ZIP file
          3. Run `DOCX_Extractor.exe`

          **macOS:**
          1. Download `DOCX_Extractor_macOS_x64.tar.gz`
          2. Extract: `tar -xzf DOCX_Extractor_macOS_x64.tar.gz`
          3. Move to Applications: `mv DOCX_Extractor.app /Applications/`
          4. Run from Applications folder
          5. If macOS blocks the app, go to System Preferences > Security & Privacy and click "Open Anyway"

          ### Usage
          1. Enter your Azure OpenAI API Key (other fields are pre-configured)
          2. Select input DOCX file
          3. Choose output location and format (CSV or JSON)
          4. Configure batch processing options (optional)
          5. Click "Start Processing"

          ### Default Configuration
          - Endpoint: https://aidt-eastus2-ai.openai.azure.com
          - API Version: 2025-03-01-preview
          - Deployment: gpt-5-chat
          - Batch Size: 10 rows
          - Max Concurrent: 5 API calls
          - Max Tokens: 20000 per batch

          ### Requirements
          - Azure OpenAI API access with gpt-5-chat deployment
          - Internet connection for API calls

          ### Command Line Tool
          You can also use the command line tool:
          ```bash
          # Basic usage
          python main.py document.docx --batch-mode -o output.csv

          # With custom settings
          python main.py document.docx --batch-mode --batch-size 20 --max-concurrent 10 --max-tokens 25000 -o output.csv
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
